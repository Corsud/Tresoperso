<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tresoperso</title>
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" id="theme-link" href="light.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <form id="login-form">
        <input type="text" id="username" placeholder="Utilisateur" required />
        <input type="password" id="password" placeholder="Mot de passe" required />
        <button type="submit">Connexion</button>
    </form>
    <div id="app" style="display:none;">
        <nav id="navbar">
            <ul class="menu">
                <li class="open">
                    <div class="menu-header">Transactions</div>
                    <ul class="submenu">
                        <li><button data-target="transactions-section">Transactions</button></li>
                    </ul>
                </li>
                <li>
                    <div class="menu-header">Analyses</div>
                    <ul class="submenu">
                        <li><button data-target="stats-section">Statistiques</button></li>
                        <li><button data-target="projection-section">Projections</button></li>
                    </ul>
                </li>
                <li>
                    <div class="menu-header">Paramètres</div>
                    <ul class="submenu">
                        <li><button data-target="settings-section">Paramètres</button></li>
                    </ul>
                </li>
            </ul>
        </nav>
        <div id="content">
            <h1>Tresoperso</h1>
            <section id="transactions-section">
                <form id="upload-form">
                    <input type="file" id="csv-file" name="file" accept=".csv" required />
                    <button type="submit">Importer CSV</button>
                </form>

                <h2>Transactions</h2>
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Moyen de paiement</th>
                            <th>Libellé</th>
                            <th>Montant</th>
                            <th>Catégorie</th>
                            <th>Sous-catégorie</th>
                            <th>Pointée</th>
                            <th>A analyser</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>

            <section id="stats-section" style="display:none;">
                <h2>Statistiques mensuelles</h2>
                <canvas id="statsChart" width="400" height="200"></canvas>
            </section>

            <section id="projection-section" style="display:none;">
                <h2>Projection</h2>
                <table id="projection-table">
                    <thead><tr><th>Mois</th><th>Montant</th></tr></thead>
                    <tbody></tbody>
                </table>
                <canvas id="projectionChart" width="400" height="200"></canvas>
            </section>

            <section id="settings-section" style="display:none;">
                <h2>Catégories</h2>
                <form id="category-form">
                    <input type="hidden" id="category-id" />
                    <input type="text" id="category-name" placeholder="Nom" required />
                    <input type="color" id="category-color" value="#000000" />
                    <button type="submit">Enregistrer</button>
                </form>
                <ul id="categories-list"></ul>

                <h3>Sous-catégories</h3>
                <form id="subcategory-form">
                    <input type="hidden" id="subcategory-id" />
                    <input type="text" id="subcategory-name" placeholder="Nom" required />
                    <select id="subcategory-category"></select>
                    <input type="color" id="subcategory-color" value="#000000" />
                    <button type="submit">Enregistrer</button>
                </form>
                <ul id="subcategories-list"></ul>

                <h2>Règles</h2>
                <form id="rule-form">
                    <input type="hidden" id="rule-id" />
                    <input type="text" id="rule-pattern" placeholder="Mot-clé" required />
                    <select id="rule-category"></select>
                    <select id="rule-subcategory">
                        <option value="">(Aucune)</option>
                    </select>
                    <button type="submit">Enregistrer</button>
                </form>
                <ul id="rules-list"></ul>
                <h2>Préférences d'affichage</h2>
                <label for="theme-select">Thème :</label>
                <select id="theme-select">
                    <option value="light">Clair</option>
                    <option value="dark">Sombre</option>
                </select>
                <label for="font-select">Police :</label>
                <select id="font-select">
                    <option value="roboto">Roboto</option>
                    <option value="arial">Arial</option>
                    <option value="geneva">Geneva</option>
                </select>
            </section>
        </div>

        <div id="category-overlay" class="overlay">
            <div class="popup">
                <select id="popup-category-select"></select>
                <button id="popup-category-save">OK</button>
            </div>
        </div>
        <div id="subcategory-overlay" class="overlay">
            <div class="popup">
                <select id="popup-subcategory-select"></select>
                <button id="popup-subcategory-save">OK</button>
            </div>
        </div>
    </div>
    <script>
        let categoriesData = [];
        let subcategoriesData = [];

        async function fetchTransactions() {
            const resp = await fetch('/transactions');
            if (!resp.ok) return;
            const data = await resp.json();
            const tbody = document.querySelector('#transactions-table tbody');
            tbody.innerHTML = '';
            data.forEach(t => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${t.date}</td><td>${t.type}</td><td>${t.payment_method}</td><td>${t.label}</td><td>${t.amount}</td>`;

                const catCell = document.createElement('td');
                const catBtn = document.createElement('button');
                catBtn.className = 'tx-cat-btn';
                catBtn.dataset.id = t.id;
                catBtn.dataset.current = t.category_id || '';
                catBtn.innerHTML = t.category ? `<span style="color:${t.category_color}">${t.category}</span>` : '(Aucune)';
                catCell.appendChild(catBtn);
                tr.appendChild(catCell);

                const subCell = document.createElement('td');
                const subBtn = document.createElement('button');
                subBtn.className = 'tx-sub-btn';
                subBtn.dataset.id = t.id;
                subBtn.dataset.current = t.subcategory_id || '';
                subBtn.innerHTML = t.subcategory ? `<span style="color:${t.subcategory_color}">${t.subcategory}</span>` : '(Aucune)';
                subCell.appendChild(subBtn);
                tr.appendChild(subCell);

                const recCell = document.createElement('td');
                const recBox = document.createElement('input');
                recBox.type = 'checkbox';
                recBox.checked = t.reconciled;
                recBox.addEventListener('change', async () => {
                    await fetch('/transactions/' + t.id, {method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({reconciled: recBox.checked})});
                    fetchTransactions();
                });
                recCell.appendChild(recBox);
                tr.appendChild(recCell);

                const analyzeCell = document.createElement('td');
                const analyzeBox = document.createElement('input');
                analyzeBox.type = 'checkbox';
                analyzeBox.checked = t.to_analyze;
                analyzeBox.addEventListener('change', async () => {
                    await fetch('/transactions/' + t.id, {method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({to_analyze: analyzeBox.checked})});
                    fetchTransactions();
                });
                analyzeCell.appendChild(analyzeBox);
                tr.appendChild(analyzeCell);

                tbody.appendChild(tr);
            });
        }

        document.getElementById('login-form').addEventListener('submit', async e => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resp = await fetch('/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, password })
            });
            if (resp.ok) {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                fetchTransactions();
                fetchCategories();
                fetchSubcategories();
                fetchRules();
                fetchStats();
                fetchProjection();
            } else {
                alert('Connexion échouée');
            }
        });

        document.getElementById('upload-form').addEventListener('submit', async e => {
            e.preventDefault();
            const fileInput = document.getElementById('csv-file');
            if (!fileInput.files.length) return;
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            const resp = await fetch('/import', { method: 'POST', body: formData });
            if (resp.ok) {
                fileInput.value = '';
                fetchTransactions();
                fetchStats();
                fetchProjection();
            } else {
                const data = await resp.json().catch(() => ({}));
                if (data.errors) {
                    alert(data.errors.join('\n'));
                } else {
                    alert(data.error || 'Erreur import');
                }
            }
        });

        async function fetchCategories() {
            const resp = await fetch('/categories');
            if (!resp.ok) return;
            const data = await resp.json();
            categoriesData = data;
            const list = document.getElementById('categories-list');
            list.innerHTML = '';
            const select = document.getElementById('rule-category');
            select.innerHTML = '';
            const popupSelect = document.getElementById('popup-category-select');
            popupSelect.innerHTML = '<option value="">(Aucune)</option>';
            const subSelectCat = document.getElementById('subcategory-category');
            subSelectCat.innerHTML = '';
            data.forEach(c => {
                const li = document.createElement('li');
                li.innerHTML = `<span style="display:inline-block;width:12px;height:12px;background:${c.color};margin-right:4px;"></span>${c.name}`;

                const edit = document.createElement('button');
                edit.textContent = 'Éditer';
                edit.onclick = () => {
                    document.getElementById('category-id').value = c.id;
                    document.getElementById('category-name').value = c.name;
                    document.getElementById('category-color').value = c.color || '#000000';
                };
                const del = document.createElement('button');
                del.textContent = 'Supprimer';
                del.onclick = async () => {
                    await fetch('/categories/' + c.id, { method: 'DELETE' });
                    fetchCategories();
                    fetchRules();
                    fetchSubcategories();
                };
                li.append(' ', edit, ' ', del);
                list.appendChild(li);

                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                select.appendChild(opt);

                const catOpt = document.createElement('option');
                catOpt.value = c.id;
                catOpt.textContent = c.name;
                subSelectCat.appendChild(catOpt);

                const popOpt = document.createElement('option');
                popOpt.value = c.id;
                popOpt.textContent = c.name;
                popupSelect.appendChild(popOpt);
            });
        }

        async function fetchSubcategories() {
            const resp = await fetch('/subcategories');
            if (!resp.ok) return;
            const data = await resp.json();
            subcategoriesData = data;
            const list = document.getElementById('subcategories-list');
            list.innerHTML = '';
            const select = document.getElementById('rule-subcategory');
            select.innerHTML = '<option value="">(Aucune)</option>';
            const popupSelect = document.getElementById('popup-subcategory-select');
            popupSelect.innerHTML = '<option value="">(Aucune)</option>';
            data.forEach(s => {
                const li = document.createElement('li');
                li.innerHTML = `${s.category} → <span style="display:inline-block;width:12px;height:12px;background:${s.color};margin-right:4px;"></span>${s.name}`;

                const edit = document.createElement('button');
                edit.textContent = 'Éditer';
                edit.onclick = () => {
                    document.getElementById('subcategory-id').value = s.id;
                    document.getElementById('subcategory-name').value = s.name;
                    document.getElementById('subcategory-category').value = s.category_id;
                    document.getElementById('subcategory-color').value = s.color || '#000000';
                };
                const del = document.createElement('button');
                del.textContent = 'Supprimer';
                del.onclick = async () => {
                    await fetch('/subcategories/' + s.id, { method: 'DELETE' });
                    fetchSubcategories();
                };
                li.append(' ', edit, ' ', del);
                list.appendChild(li);

                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.category} - ${s.name}`;
                select.appendChild(opt);

                const popOpt = document.createElement('option');
                popOpt.value = s.id;
                popOpt.textContent = `${s.category} - ${s.name}`;
                popupSelect.appendChild(popOpt);
            });
        }

        async function fetchRules() {
            const resp = await fetch('/rules');
            if (!resp.ok) return;
            const data = await resp.json();
            const list = document.getElementById('rules-list');
            list.innerHTML = '';
            data.forEach(r => {
                const li = document.createElement('li');
                const cat = r.category || '';
                const sub = r.subcategory ? ' / ' + r.subcategory : '';
                li.textContent = `${r.pattern} → ${cat}${sub}`;
                const edit = document.createElement('button');
                edit.textContent = 'Éditer';
                edit.onclick = () => {
                    document.getElementById('rule-id').value = r.id;
                    document.getElementById('rule-pattern').value = r.pattern;
                    document.getElementById('rule-category').value = r.category_id;
                    document.getElementById('rule-subcategory').value = r.subcategory_id || '';
                };
                const del = document.createElement('button');
                del.textContent = 'Supprimer';
                del.onclick = async () => {
                    await fetch('/rules/' + r.id, { method: 'DELETE' });
                    fetchRules();
                };
                li.append(' ', edit, ' ', del);
                list.appendChild(li);
            });
        }

       document.getElementById('category-form').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('category-id').value;
            const name = document.getElementById('category-name').value;
            const color = document.getElementById('category-color').value;
            if (id) {
                await fetch('/categories/' + id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name, color }) });
            } else {
                await fetch('/categories', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name, color }) });
            }
            document.getElementById('category-id').value = '';
            document.getElementById('category-name').value = '';
            document.getElementById('category-color').value = '#000000';
            fetchCategories();
            fetchRules();
            fetchSubcategories();
        });

        document.getElementById('subcategory-form').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('subcategory-id').value;
            const name = document.getElementById('subcategory-name').value;
            const category_id = document.getElementById('subcategory-category').value;
            const color = document.getElementById('subcategory-color').value;
            const payload = { name, category_id, color };
            if (id) {
                await fetch('/subcategories/' + id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            } else {
                await fetch('/subcategories', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            }
            document.getElementById('subcategory-id').value = '';
            document.getElementById('subcategory-name').value = '';
            document.getElementById('subcategory-color').value = '#000000';
            fetchSubcategories();
        });

        document.getElementById('rule-form').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('rule-id').value;
            const pattern = document.getElementById('rule-pattern').value;
            const category_id = document.getElementById('rule-category').value;
            const subcategory_id = document.getElementById('rule-subcategory').value;
            const payload = { pattern, category_id, subcategory_id };
            if (id) {
                await fetch('/rules/' + id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            } else {
                await fetch('/rules', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            }
            document.getElementById('rule-id').value = '';
            document.getElementById('rule-pattern').value = '';
            document.getElementById('rule-subcategory').value = '';
            fetchRules();
        });

        let statsChart;
        let projChart;

        async function fetchStats() {
            const resp = await fetch('/stats');
            if (!resp.ok) return;
            const data = await resp.json();
            const ctx = document.getElementById('statsChart').getContext('2d');
            if (statsChart) statsChart.destroy();
            statsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: 'Total mensuel',
                        data: data.map(d => d.total),
                        backgroundColor: 'rgba(75, 192, 192, 0.5)'
                    }]
                }
            });
        }

        function drawProjectionChart() {
            const rows = document.querySelectorAll('#projection-table tbody tr');
            const labels = [];
            const values = [];
            rows.forEach(r => {
                labels.push(r.children[0].textContent);
                values.push(parseFloat(r.querySelector('input').value) || 0);
            });
            const ctx = document.getElementById('projectionChart').getContext('2d');
            if (projChart) projChart.destroy();
            projChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Projection',
                        data: values,
                        fill: false,
                        borderColor: 'rgba(153, 102, 255, 1)'
                    }]
                }
            });
        }

        async function fetchProjection() {
            const resp = await fetch('/projection');
            if (!resp.ok) return;
            const data = await resp.json();
            const tbody = document.querySelector('#projection-table tbody');
            tbody.innerHTML = '';
            data.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${d.month}</td><td><input type="number" step="0.01" value="${d.amount}"></td>`;
                tbody.appendChild(tr);
            });
            drawProjectionChart();
        }

        document.getElementById('projection-table').addEventListener('input', drawProjectionChart);

        let currentCatBtn = null;
        let currentSubBtn = null;
        const catOverlay = document.getElementById('category-overlay');
        const subOverlay = document.getElementById('subcategory-overlay');

        document.getElementById('transactions-table').addEventListener('click', e => {
            if (e.target.classList.contains('tx-cat-btn')) {
                currentCatBtn = e.target;
                document.getElementById('popup-category-select').value = currentCatBtn.dataset.current || '';
                catOverlay.style.display = 'flex';
            } else if (e.target.classList.contains('tx-sub-btn')) {
                currentSubBtn = e.target;
                document.getElementById('popup-subcategory-select').value = currentSubBtn.dataset.current || '';
                subOverlay.style.display = 'flex';
            }
        });

        catOverlay.addEventListener('click', e => { if (e.target === catOverlay) catOverlay.style.display = 'none'; });
        subOverlay.addEventListener('click', e => { if (e.target === subOverlay) subOverlay.style.display = 'none'; });

        document.getElementById('popup-category-save').addEventListener('click', async () => {
            if (!currentCatBtn) return;
            const id = currentCatBtn.dataset.id;
            const val = document.getElementById('popup-category-select').value;
            const resp = await fetch('/transactions/' + id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ category_id: val }) });
            if (resp.ok) {
                fetchTransactions();

            }
            catOverlay.style.display = 'none';
            currentCatBtn = null;
        });

        document.getElementById('popup-subcategory-save').addEventListener('click', async () => {
            if (!currentSubBtn) return;
            const id = currentSubBtn.dataset.id;
            const val = document.getElementById('popup-subcategory-select').value;
            const resp = await fetch('/transactions/' + id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ subcategory_id: val }) });
            if (resp.ok) {
                fetchTransactions();

            }
            subOverlay.style.display = 'none';
            currentSubBtn = null;
        });

        const sectionIds = ['transactions-section', 'stats-section', 'projection-section', 'settings-section'];
        const sidebarButtons = document.querySelectorAll('#navbar .submenu button');
        sidebarButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.target;
                sectionIds.forEach(id => {
                    document.getElementById(id).style.display = id === target ? 'block' : 'none';
                });
                sidebarButtons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
            });
        });
        if (sidebarButtons.length) {
            sidebarButtons[0].classList.add('selected');
        }

        document.querySelectorAll('#navbar .menu-header').forEach(header => {
            header.addEventListener('click', () => {
                header.parentElement.classList.toggle('open');
            });
        });

        const themeSelect = document.getElementById('theme-select');
        const fontSelect = document.getElementById('font-select');
        const themeLink = document.getElementById('theme-link');

        function applyPreferences() {
            const theme = localStorage.getItem('theme') || 'light';
            const font = localStorage.getItem('font') || 'roboto';
            themeLink.href = theme + '.css';
            document.body.classList.remove('font-roboto', 'font-arial', 'font-geneva');
            document.body.classList.add('font-' + font);
            themeSelect.value = theme;
            fontSelect.value = font;
        }

        themeSelect.addEventListener('change', () => {
            localStorage.setItem('theme', themeSelect.value);
            applyPreferences();
        });
        fontSelect.addEventListener('change', () => {
            localStorage.setItem('font', fontSelect.value);
            applyPreferences();
        });

        applyPreferences();
    </script>
</body>
</html>
