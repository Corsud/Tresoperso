<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tresoperso</title>
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" id="theme-link" href="light.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <form id="login-form">
        <input type="text" id="username" placeholder="Utilisateur" required />
        <input type="password" id="password" placeholder="Mot de passe" required />
        <button type="submit">Connexion</button>
    </form>
    <div id="app" style="display:none;">
        <nav id="navbar">
            <ul class="menu">
                <li class="open">
                    <div class="menu-header">Transactions</div>
                    <ul class="submenu">
                        <li><button data-target="transactions-section">Transactions</button></li>
                    </ul>
                </li>
                <li>
                    <div class="menu-header">Analyses</div>
                    <ul class="submenu">
                        <li><button data-target="stats-section">Statistiques</button></li>
                        <li><button data-target="projection-section">Projections</button></li>
                    </ul>
                </li>
                <li>
                    <div class="menu-header">Paramètres</div>
                    <ul class="submenu">
                        <li><button data-target="settings-section">Paramètres</button></li>
                    </ul>
                </li>
            </ul>
        </nav>
        <div id="content">
            <h1>Tresoperso</h1>
            <section id="transactions-section">
                <form id="upload-form">
                    <input type="file" id="csv-file" name="file" accept=".csv" required />
                    <button type="submit">Importer CSV</button>
                </form>

                <div id="account-controls">
                    <label for="account-select">Compte :</label>
                    <select id="account-select">
                        <option value="">(Tous)</option>
                    </select>
                    <span id="account-info"></span>
                </div>

                <h2>Transactions</h2>
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Moyen de paiement</th>
                            <th>Libellé</th>
                            <th>Montant</th>
                            <th>Catégorie</th>
                            <th>Sous-catégorie</th>
                            <th>Règle</th>
                            <th>Pointée</th>
                            <th>A analyser</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>

            <section id="stats-section" style="display:none;">
                <h2>Statistiques mensuelles</h2>
                <canvas id="statsChart" width="400" height="200"></canvas>
            </section>

            <section id="projection-section" style="display:none;">
                <h2>Projection</h2>
                <table id="projection-table">
                    <thead><tr><th>Mois</th><th>Montant</th></tr></thead>
                    <tbody></tbody>
                </table>
                <canvas id="projectionChart" width="400" height="200"></canvas>
            </section>

            <section id="settings-section" style="display:none;">
                <div id="catsubs-container">
                    <div class="settings-col">
                        <h2>Catégories</h2>
                        <form id="category-form">
                            <input type="hidden" id="category-id" />
                            <input type="text" id="category-name" placeholder="Nom" required />
                            <input type="color" id="category-color" value="#000000" />
                            <button type="submit">Enregistrer</button>
                        </form>
                        <ul id="categories-list"></ul>
                    </div>
                    <div class="settings-col">
                        <h3>Sous-catégories</h3>
                        <form id="subcategory-form">
                            <input type="hidden" id="subcategory-id" />
                            <input type="text" id="subcategory-name" placeholder="Nom" required />
                            <select id="subcategory-category"></select>
                            <input type="color" id="subcategory-color" value="#000000" />
                            <button type="submit">Enregistrer</button>
                        </form>
                        <ul id="subcategories-list"></ul>
                    </div>
                </div>

                <h2 style="display:none;">Règles</h2>
                <form id="rule-form" style="display:none;">
                    <input type="hidden" id="rule-id" />
                    <input type="text" id="rule-pattern" placeholder="Mot-clé" required />
                    <select id="rule-category"></select>
                    <select id="rule-subcategory">
                        <option value="">(Aucune)</option>
                    </select>
                    <button type="submit">Enregistrer</button>
                </form>
                <ul id="rules-list" style="display:none;"></ul>
                <h2>Préférences d'affichage</h2>
                <label for="theme-select">Thème :</label>
                <select id="theme-select">
                    <option value="light">Clair</option>
                    <option value="dark">Sombre</option>
                </select>
                <label for="font-select">Police :</label>
                <select id="font-select">
                    <option value="roboto">Roboto</option>
                    <option value="arial">Arial</option>
                    <option value="geneva">Geneva</option>
                </select>

                <h2>RESET</h2>
                <button id="reset-transactions">Effacer les transactions</button>
            </section>
        </div>

        <div id="category-overlay" class="overlay">
            <div class="popup">
                <select id="popup-category-select"></select>
                <button id="popup-category-save">OK</button>
            </div>
        </div>
        <div id="subcategory-overlay" class="overlay">
            <div class="popup">
                <select id="popup-subcategory-select"></select>
                <button id="popup-subcategory-save">OK</button>
            </div>
        </div>
        <div id="duplicate-overlay" class="overlay">
            <div class="popup">
                <form id="duplicate-form">
                    <h3>Doublons détectés</h3>
                    <ul id="duplicate-list"></ul>
                    <button type="submit">Insérer la sélection</button>
                </form>
            </div>
        </div>
        <div id="rule-overlay" class="overlay">
            <div class="popup">
                <div id="rule-label-checkboxes"></div>
                <select id="rule-overlay-category"></select>
                <select id="rule-overlay-subcategory"></select>
                <button id="rule-overlay-save">OK</button>
            </div>
        </div>
    </div>
    <script>
        let categoriesData = [];
        let subcategoriesData = [];
        let accountsData = [];
        let selectedAccountId = '';

        function findCategory(id) {
            return categoriesData.find(c => String(c.id) === String(id));
        }

        function findSubcategory(id) {
            return subcategoriesData.find(s => String(s.id) === String(id));
        }

        function formatAmount(v) {
            return (v || 0).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function updateAccountDropdown() {
            const select = document.getElementById('account-select');
            select.innerHTML = '<option value="">(Tous)</option>';
            accountsData.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a.id;
                opt.textContent = `${a.account_type} ${a.number}`.trim();
                select.appendChild(opt);
            });
            select.value = selectedAccountId;
        }

        function displayAccountInfo() {
            const info = document.getElementById('account-info');
            const acc = accountsData.find(a => String(a.id) === String(selectedAccountId));
            if (acc) {
                const date = acc.export_date ? ` - export ${acc.export_date}` : '';
                info.textContent = `${acc.account_type} ${acc.number}${date}`.trim();
            } else {
                info.textContent = '';
            }
        }

        async function fetchTransactions() {
            const url = selectedAccountId ? `/transactions?account_id=${selectedAccountId}` : '/transactions';
            const resp = await fetch(url);
            if (!resp.ok) return;
            const data = await resp.json();
            displayAccountInfo();
            const tbody = document.querySelector('#transactions-table tbody');
            tbody.innerHTML = '';
            data.forEach(t => {
                const tr = document.createElement('tr');
                const type = t.type || '';
                const pay = t.payment_method || '';

                const dateCell = document.createElement('td');
                dateCell.textContent = t.date;
                tr.appendChild(dateCell);

                const typeCell = document.createElement('td');
                typeCell.textContent = type;
                tr.appendChild(typeCell);

                const payCell = document.createElement('td');
                payCell.textContent = pay;
                tr.appendChild(payCell);

                const labelCell = document.createElement('td');
                labelCell.textContent = t.label;
                tr.appendChild(labelCell);

                const amountCell = document.createElement('td');
                amountCell.textContent = formatAmount(t.amount);
                tr.appendChild(amountCell);

                const catCell = document.createElement('td');
                const catBtn = document.createElement('button');
                catBtn.className = 'tx-cat-btn';
                catBtn.dataset.id = t.id;
                catBtn.dataset.current = t.category_id || '';
                if (t.category) {
                    catBtn.textContent = t.category;
                    catBtn.style.color = t.category_color || '';
                } else {
                    catBtn.textContent = '(Aucune)';
                    catBtn.style.color = '';
                }
                catCell.appendChild(catBtn);
                tr.appendChild(catCell);

                const subCell = document.createElement('td');
                const subBtn = document.createElement('button');
                subBtn.className = 'tx-sub-btn';
                subBtn.dataset.id = t.id;
                subBtn.dataset.current = t.subcategory_id || '';
                if (t.subcategory) {
                    subBtn.textContent = t.subcategory;
                    subBtn.style.color = t.subcategory_color || '';
                } else {
                    subBtn.textContent = '(Aucune)';
                    subBtn.style.color = '';
                }
                subCell.appendChild(subBtn);
                tr.appendChild(subCell);

                const ruleCell = document.createElement('td');
                const ruleBtn = document.createElement('button');
                ruleBtn.className = 'tx-rule-btn';
                ruleBtn.textContent = '⚙️';
                ruleBtn.dataset.label = t.label;
                ruleBtn.dataset.category = t.category_id || '';
                ruleBtn.dataset.subcategory = t.subcategory_id || '';
                ruleCell.appendChild(ruleBtn);
                tr.appendChild(ruleCell);

                const recCell = document.createElement('td');
                const recBox = document.createElement('input');
                recBox.type = 'checkbox';
                recBox.checked = t.reconciled;
                recBox.addEventListener('change', async () => {
                    await fetch('/transactions/' + t.id, {method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({reconciled: recBox.checked})});
                    fetchTransactions();
                });
                recCell.appendChild(recBox);
                tr.appendChild(recCell);

                const analyzeCell = document.createElement('td');
                const analyzeBox = document.createElement('input');
                analyzeBox.type = 'checkbox';
                analyzeBox.checked = t.to_analyze;
                analyzeBox.addEventListener('change', async () => {
                    await fetch('/transactions/' + t.id, {method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({to_analyze: analyzeBox.checked})});
                    fetchTransactions();
                });
                analyzeCell.appendChild(analyzeBox);
                tr.appendChild(analyzeCell);

                tbody.appendChild(tr);
            });
        }

        document.getElementById('login-form').addEventListener('submit', async e => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resp = await fetch('/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, password })
            });
            if (resp.ok) {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                updateAccountDropdown();
                displayAccountInfo();
                fetchTransactions();
                fetchCategories();
                fetchSubcategories();
                fetchRules();
                fetchStats();
                fetchProjection();
            } else {
                alert('Connexion échouée');
            }
        });

        document.getElementById('upload-form').addEventListener('submit', async e => {
            e.preventDefault();
            const fileInput = document.getElementById('csv-file');
            if (!fileInput.files.length) return;
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            const resp = await fetch('/import', { method: 'POST', body: formData });
            const data = await resp.json().catch(() => ({}));
            if (resp.ok) {
                fileInput.value = '';
                if (data.account) {
                    const exists = accountsData.some(a => String(a.id) === String(data.account.id));
                    if (!exists) accountsData.push(data.account);
                    selectedAccountId = data.account.id;
                    updateAccountDropdown();
                    displayAccountInfo();
                }
                if (data.duplicates && data.duplicates.length) {
                    showDuplicates(data.duplicates, data.account ? data.account.id : '');
                } else {
                    fetchTransactions();
                    fetchStats();
                    fetchProjection();
                }
            } else {
                if (data.errors) {
                    alert(data.errors.join('\n'));
                } else {
                    alert(data.error || 'Erreur import');
                }
            }
        });

        async function fetchCategories() {
            const resp = await fetch('/categories');
            if (!resp.ok) return;
            const data = await resp.json();
            categoriesData = data;
            const list = document.getElementById('categories-list');
            list.innerHTML = '';
            const select = document.getElementById('rule-category');
            select.innerHTML = '';
            const overlayCat = document.getElementById('rule-overlay-category');
            if (overlayCat) overlayCat.innerHTML = '';
            const popupSelect = document.getElementById('popup-category-select');
            popupSelect.innerHTML = '<option value="">(Aucune)</option>';
            const subSelectCat = document.getElementById('subcategory-category');
            subSelectCat.innerHTML = '';
            data.forEach(c => {
                const li = document.createElement('li');
                const colorSpan = document.createElement('span');
                colorSpan.style.display = 'inline-block';
                colorSpan.style.width = '12px';
                colorSpan.style.height = '12px';
                colorSpan.style.background = c.color;
                colorSpan.style.marginRight = '4px';
                li.appendChild(colorSpan);
                li.appendChild(document.createTextNode(c.name));

                const edit = document.createElement('button');
                edit.textContent = 'Éditer';
                edit.onclick = () => {
                    document.getElementById('category-id').value = c.id;
                    document.getElementById('category-name').value = c.name;
                    document.getElementById('category-color').value = c.color || '#000000';
                };
                const del = document.createElement('button');
                del.textContent = 'Supprimer';
                del.onclick = async () => {
                    await fetch('/categories/' + c.id, { method: 'DELETE' });
                    fetchCategories();
                    fetchRules();
                    fetchSubcategories();
                };
                li.append(' ', edit, ' ', del);
                list.appendChild(li);

                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                select.appendChild(opt);
                if (overlayCat) {
                    const o2 = document.createElement('option');
                    o2.value = c.id;
                    o2.textContent = c.name;
                    overlayCat.appendChild(o2);
                }

                const catOpt = document.createElement('option');
                catOpt.value = c.id;
                catOpt.textContent = c.name;
                subSelectCat.appendChild(catOpt);

                const popOpt = document.createElement('option');
                popOpt.value = c.id;
                popOpt.textContent = c.name;
                popupSelect.appendChild(popOpt);
            });

            subSelectCat.onchange = () => {
                const cat = findCategory(subSelectCat.value);
                const colorInput = document.getElementById('subcategory-color');
                if (cat && colorInput) {
                    colorInput.value = cat.color || '#000000';
                }
            };
            if (subSelectCat.value) {
                subSelectCat.onchange();
            }
        }

        async function fetchSubcategories() {
            const resp = await fetch('/subcategories');
            if (!resp.ok) return;
            const data = await resp.json();
            subcategoriesData = data;
            const list = document.getElementById('subcategories-list');
            list.innerHTML = '';
            const select = document.getElementById('rule-subcategory');
            select.innerHTML = '<option value="">(Aucune)</option>';
            const overlaySub = document.getElementById('rule-overlay-subcategory');
            if (overlaySub) overlaySub.innerHTML = '<option value="">(Aucune)</option>';
            const popupSelect = document.getElementById('popup-subcategory-select');
            popupSelect.innerHTML = '<option value="">(Aucune)</option>';
            data.forEach(s => {
                const li = document.createElement('li');
                li.appendChild(document.createTextNode(`${s.category} → `));
                const colorSpan = document.createElement('span');
                colorSpan.style.display = 'inline-block';
                colorSpan.style.width = '12px';
                colorSpan.style.height = '12px';
                colorSpan.style.background = s.color;
                colorSpan.style.marginRight = '4px';
                li.appendChild(colorSpan);
                li.appendChild(document.createTextNode(s.name));

                const edit = document.createElement('button');
                edit.textContent = 'Éditer';
                edit.onclick = () => {
                    document.getElementById('subcategory-id').value = s.id;
                    document.getElementById('subcategory-name').value = s.name;
                    document.getElementById('subcategory-category').value = s.category_id;
                    document.getElementById('subcategory-color').value = s.color || '#000000';
                };
                const del = document.createElement('button');
                del.textContent = 'Supprimer';
                del.onclick = async () => {
                    await fetch('/subcategories/' + s.id, { method: 'DELETE' });
                    fetchSubcategories();
                };
                li.append(' ', edit, ' ', del);
                list.appendChild(li);

                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.category} - ${s.name}`;
                select.appendChild(opt);
                if (overlaySub) {
                    const o2 = document.createElement('option');
                    o2.value = s.id;
                    o2.textContent = `${s.category} - ${s.name}`;
                    overlaySub.appendChild(o2);
                }

                const popOpt = document.createElement('option');
                popOpt.value = s.id;
                popOpt.textContent = `${s.category} - ${s.name}`;
                popupSelect.appendChild(popOpt);
            });
        }

        async function fetchRules() {
            const resp = await fetch('/rules');
            if (!resp.ok) return;
            const data = await resp.json();
            const list = document.getElementById('rules-list');
            list.innerHTML = '';
            data.forEach(r => {
                const li = document.createElement('li');
                const cat = r.category || '';
                const sub = r.subcategory ? ' / ' + r.subcategory : '';
                li.textContent = `${r.pattern} → ${cat}${sub}`;
                const edit = document.createElement('button');
                edit.textContent = 'Éditer';
                edit.onclick = () => {
                    document.getElementById('rule-id').value = r.id;
                    document.getElementById('rule-pattern').value = r.pattern;
                    document.getElementById('rule-category').value = r.category_id;
                    document.getElementById('rule-subcategory').value = r.subcategory_id || '';
                };
                const del = document.createElement('button');
                del.textContent = 'Supprimer';
                del.onclick = async () => {
                    await fetch('/rules/' + r.id, { method: 'DELETE' });
                    fetchRules();
                };
                li.append(' ', edit, ' ', del);
                list.appendChild(li);
            });
        }

       document.getElementById('category-form').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('category-id').value;
            const name = document.getElementById('category-name').value;
            const color = document.getElementById('category-color').value;
            if (id) {
                await fetch('/categories/' + id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name, color }) });
            } else {
                await fetch('/categories', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name, color }) });
            }
            document.getElementById('category-id').value = '';
            document.getElementById('category-name').value = '';
            document.getElementById('category-color').value = '#000000';
            fetchCategories();
            fetchRules();
            fetchSubcategories();
        });

        document.getElementById('subcategory-form').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('subcategory-id').value;
            const name = document.getElementById('subcategory-name').value;
            const category_id = document.getElementById('subcategory-category').value;
            const color = document.getElementById('subcategory-color').value;
            const payload = { name, category_id, color };
            if (id) {
                await fetch('/subcategories/' + id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            } else {
                await fetch('/subcategories', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            }
            document.getElementById('subcategory-id').value = '';
            document.getElementById('subcategory-name').value = '';
            document.getElementById('subcategory-color').value = '#000000';
            fetchSubcategories();
        });

        document.getElementById('rule-form').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('rule-id').value;
            const pattern = document.getElementById('rule-pattern').value;
            const category_id = document.getElementById('rule-category').value;
            const subcategory_id = document.getElementById('rule-subcategory').value;
            const payload = { pattern, category_id, subcategory_id };
            if (id) {
                await fetch('/rules/' + id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            } else {
                await fetch('/rules', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            }
            document.getElementById('rule-id').value = '';
            document.getElementById('rule-pattern').value = '';
            document.getElementById('rule-subcategory').value = '';
            fetchRules();
        });

        let statsChart;
        let projChart;

        async function fetchStats() {
            const resp = await fetch('/stats');
            if (!resp.ok) return;
            const data = await resp.json();
            const ctx = document.getElementById('statsChart').getContext('2d');
            if (statsChart) statsChart.destroy();
            statsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: 'Total mensuel',
                        data: data.map(d => d.total),
                        backgroundColor: 'rgba(75, 192, 192, 0.5)'
                    }]
                }
            });
        }

        function drawProjectionChart() {
            const rows = document.querySelectorAll('#projection-table tbody tr');
            const labels = [];
            const values = [];
            rows.forEach(r => {
                labels.push(r.children[0].textContent);
                values.push(parseFloat(r.querySelector('input').value) || 0);
            });
            const ctx = document.getElementById('projectionChart').getContext('2d');
            if (projChart) projChart.destroy();
            projChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Projection',
                        data: values,
                        fill: false,
                        borderColor: 'rgba(153, 102, 255, 1)'
                    }]
                }
            });
        }

        async function fetchProjection() {
            const resp = await fetch('/projection');
            if (!resp.ok) return;
            const data = await resp.json();
            const tbody = document.querySelector('#projection-table tbody');
            tbody.innerHTML = '';
            data.forEach(d => {
                const tr = document.createElement('tr');
                const monthCell = document.createElement('td');
                monthCell.textContent = d.month;
                tr.appendChild(monthCell);

                const amountCell = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.01';
                input.value = d.amount;
                amountCell.appendChild(input);
                tr.appendChild(amountCell);

                tbody.appendChild(tr);
            });
            drawProjectionChart();
        }

        document.getElementById('projection-table').addEventListener('input', drawProjectionChart);

        let currentCatBtn = null;
        let currentSubBtn = null;
        let currentRuleBtn = null;
        const catOverlay = document.getElementById('category-overlay');
        const subOverlay = document.getElementById('subcategory-overlay');
        const dupOverlay = document.getElementById('duplicate-overlay');
        const ruleOverlay = document.getElementById('rule-overlay');

        document.getElementById('transactions-table').addEventListener('click', e => {
            if (e.target.classList.contains('tx-cat-btn')) {
                currentCatBtn = e.target;
                document.getElementById('popup-category-select').value = currentCatBtn.dataset.current || '';
                catOverlay.style.display = 'flex';
            } else if (e.target.classList.contains('tx-sub-btn')) {
                currentSubBtn = e.target;
                document.getElementById('popup-subcategory-select').value = currentSubBtn.dataset.current || '';
                subOverlay.style.display = 'flex';
            } else if (e.target.classList.contains('tx-rule-btn')) {
                currentRuleBtn = e.target;
                const words = (currentRuleBtn.dataset.label || '').split(/[^\wÀ-ÿ]+/).filter(Boolean);
                const cont = document.getElementById('rule-label-checkboxes');
                cont.innerHTML = '';
                words.forEach(w => {
                    const lbl = document.createElement('label');
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.value = w;
                    lbl.appendChild(cb);
                    lbl.append(' ' + w + ' ');
                    cont.appendChild(lbl);
                });
                document.getElementById('rule-overlay-category').value = currentRuleBtn.dataset.category || '';
                document.getElementById('rule-overlay-subcategory').value = currentRuleBtn.dataset.subcategory || '';
                ruleOverlay.style.display = 'flex';
            }
        });

        catOverlay.addEventListener('click', e => { if (e.target === catOverlay) catOverlay.style.display = 'none'; });
        subOverlay.addEventListener('click', e => { if (e.target === subOverlay) subOverlay.style.display = 'none'; });
        ruleOverlay.addEventListener('click', e => { if (e.target === ruleOverlay) ruleOverlay.style.display = 'none'; });

        function showDuplicates(dups, accountId) {
            const list = document.getElementById('duplicate-list');
            list.innerHTML = '';
            dupOverlay.dataset.rows = JSON.stringify(dups);
            dupOverlay.dataset.accountId = accountId || '';
            dups.forEach((d, idx) => {
                const li = document.createElement('li');
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = true;
                cb.dataset.index = idx;
                li.appendChild(cb);
                li.appendChild(document.createTextNode(`${d.date} - ${d.label} - ${formatAmount(d.amount)}`));
                list.appendChild(li);
            });
            dupOverlay.style.display = 'flex';
        }

        dupOverlay.addEventListener('click', e => { if (e.target === dupOverlay) dupOverlay.style.display = 'none'; });
        document.getElementById('duplicate-form').addEventListener('submit', async e => {
            e.preventDefault();
            const rows = JSON.parse(dupOverlay.dataset.rows || '[]');
            const selected = [];
            document.querySelectorAll('#duplicate-list input[type="checkbox"]').forEach(cb => {
                if (cb.checked) selected.push(rows[cb.dataset.index]);
            });
            dupOverlay.style.display = 'none';
            if (!selected.length) {
                fetchTransactions();
                fetchStats();
                fetchProjection();
                return;
            }
            const resp = await fetch('/import/confirm', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ transactions: selected, account_id: dupOverlay.dataset.accountId })
            });
            const data = await resp.json().catch(() => ({}));
            if (resp.ok) {
                fetchTransactions();
                fetchStats();
                fetchProjection();
            } else {
                if (data.errors) alert(data.errors.join('\n')); else alert(data.error || 'Erreur import');
            }
        });

        document.getElementById('popup-category-save').addEventListener('click', async () => {
            if (!currentCatBtn) return;
            const id = currentCatBtn.dataset.id;
            const val = document.getElementById('popup-category-select').value;
            const resp = await fetch('/transactions/' + id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ category_id: val }) });
            if (resp.ok) {
                const cat = findCategory(val);
                currentCatBtn.dataset.current = val;
                if (cat) {
                    currentCatBtn.textContent = cat.name;
                    currentCatBtn.style.color = cat.color || '';
                } else {
                    currentCatBtn.textContent = '(Aucune)';
                    currentCatBtn.style.color = '';
                }
                fetchTransactions();
            }
            catOverlay.style.display = 'none';
            currentCatBtn = null;
        });

        document.getElementById('popup-subcategory-save').addEventListener('click', async () => {
            if (!currentSubBtn) return;
            const id = currentSubBtn.dataset.id;
            const val = document.getElementById('popup-subcategory-select').value;
            const resp = await fetch('/transactions/' + id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ subcategory_id: val }) });
            if (resp.ok) {
                const sub = findSubcategory(val);
                currentSubBtn.dataset.current = val;
                if (sub) {
                    currentSubBtn.textContent = `${sub.category} - ${sub.name}`;
                    currentSubBtn.style.color = sub.color || '';
                } else {
                    currentSubBtn.textContent = '(Aucune)';
                    currentSubBtn.style.color = '';
                }
                fetchTransactions();
            }
            subOverlay.style.display = 'none';
            currentSubBtn = null;
        });

        document.getElementById('rule-overlay-save').addEventListener('click', async () => {
            if (!currentRuleBtn) return;
            const words = Array.from(document.querySelectorAll('#rule-label-checkboxes input:checked')).map(cb => cb.value);
            const category_id = document.getElementById('rule-overlay-category').value;
            const subcategory_id = document.getElementById('rule-overlay-subcategory').value;
            const pattern = words.join(' ');
            if (pattern && category_id) {
                await fetch('/rules', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ pattern, category_id, subcategory_id })
                });
                fetchTransactions();
            }
            ruleOverlay.style.display = 'none';
            currentRuleBtn = null;
        });

        const sectionIds = ['transactions-section', 'stats-section', 'projection-section', 'settings-section'];
        const sidebarButtons = document.querySelectorAll('#navbar .submenu button');
        sidebarButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.target;
                sectionIds.forEach(id => {
                    document.getElementById(id).style.display = id === target ? 'block' : 'none';
                });
                sidebarButtons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
            });
        });
        if (sidebarButtons.length) {
            sidebarButtons[0].classList.add('selected');
        }

        document.querySelectorAll('#navbar .menu-header').forEach(header => {
            header.addEventListener('click', () => {
                header.parentElement.classList.toggle('open');
            });
        });

        const themeSelect = document.getElementById('theme-select');
        const fontSelect = document.getElementById('font-select');
        const themeLink = document.getElementById('theme-link');
        const accountSelect = document.getElementById('account-select');

        function applyPreferences() {
            const theme = localStorage.getItem('theme') || 'light';
            const font = localStorage.getItem('font') || 'roboto';
            themeLink.href = theme + '.css';
            document.body.classList.remove('font-roboto', 'font-arial', 'font-geneva');
            document.body.classList.add('font-' + font);
            themeSelect.value = theme;
            fontSelect.value = font;
        }

        themeSelect.addEventListener('change', () => {
            localStorage.setItem('theme', themeSelect.value);
            applyPreferences();
        });
        fontSelect.addEventListener('change', () => {
            localStorage.setItem('font', fontSelect.value);
            applyPreferences();
        });

        accountSelect.addEventListener('change', () => {
            selectedAccountId = accountSelect.value;
            fetchTransactions();
        });

        document.getElementById('reset-transactions').addEventListener('click', async () => {
            if (!confirm('Confirmer la suppression de toutes les transactions ?')) return;
            const resp = await fetch('/reset', {method: 'POST'});
            if (resp.ok) {
                fetchTransactions();
                fetchStats();
                fetchProjection();
            }
        });

        applyPreferences();
    </script>
</body>
</html>
